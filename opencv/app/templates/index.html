<html>
  <head>
    <title>Camera Station</title>
    <style>
      .outline {
        border-style: solid;
        border-color: red;
        border-width: 4px;
      }
    </style>
  </head>

  <body>
    <div class="row">
      <h1>Camera Station</h1>
    </div>
    <div class="row">
      <img src="/camera">
    </div>
    <div class="row action" name="bounds">
      <button id="bounds">Bounds</button>
      <span id="boundsResult"></span>
    </div>
    <div class="row">
      <button id="snapshot">Snapshot</button>
      <span id="snapshotResult"></span>
    </div>
    <div class="row action" name="photos">
      <button id="photos">Photos</button>
      <span id="photosResult"></span>
    </div>
    <div class="row action" name="tare">
      <button id="tare">Tare</button>
      <span id="tareResult"></span>
    </div>
    <div class="row action" name="weight" action="GET">
      <button id="weight">Weight</button>
      <span id="weightResult"></span>
    </div>
    <form class="row" id="configOptions">
      <input type="range" min="0" max="255" name="threshold" id="thresholdConfig">
      <output name="thresholdOutput"></output>
      <input type="submit" value="Configure">
    </form>

    <script>
      (function () {
        "use strict";

        function submit_threshold() {
          let form = document.getElementById("configOptions")
          // console.log(form);
          fetch(
            "/config", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({threshold: form.elements["threshold"].value}),
            }
          ).finally(function () {
            // form.reset();
          })
        }

        let configOptions = document.getElementById("configOptions")
        configOptions.addEventListener("input", function (event) {
          let form = document.getElementById("configOptions");
          form.elements["thresholdOutput"].value = form.elements["threshold"].value;
          submit_threshold();
        });
        // console.log(configOptions);
        configOptions.addEventListener("submit", function (event) {
          // console.log(event);
          event.preventDefault();
          submit_threshold();
          return false
        });

        function repeat(func, times, delay) {
          func(times);
          if (times > 0) {
            setTimeout(() => repeat(func, times - 1, delay), delay);
          }
        }

        let snapshotButton = document.getElementById("snapshot");
        snapshotButton.addEventListener("click", function (event) {
          repeat(function (index) {
            fetch("/snap", {
              method: "POST"
            }).then(function (response) {
              response.text().then(text => document.getElementById("snapshotResult").textContent = text);
              snapshotButton.classList.add("outline");
              setTimeout(() => snapshotButton.classList.remove("outline"), 1000);
            })
          }, 10, 15000);
        });

        // let photoButton = document.getElementById("photos");
        // photoButton.addEventListener("click", function (event) {
        //   fetch("/photos", {
        //     method: "POST"
        //   });
        // })

        // Setup 'actions'.
        // Each action is a div containing a button for input
        // and a span for output.
        // Pressing the button submits a POST request to the endpoint
        // identified by the 'name' attribute of the row.
        let actions = document.getElementsByClassName("action")
        for (const action of actions) {
          let button = action.children[0];
          let output = action.children[1];
          let httpMethod = action.getAttribute("action");
          if (httpMethod === null) {
            httpMethod = "POST";
          }
          button.addEventListener("click", function (event) {
            output.textContent = "Working...";
            fetch("/" + action.getAttribute("name"), {
              method: httpMethod
            }).then(function (response) {
              response.text().then(text => output.textContent = text);
            })
          });
        }

      })();
    </script>
  </body>
</html>